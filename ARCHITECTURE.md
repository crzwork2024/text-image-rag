# 🏗️ RAG 智能问答系统 - 架构设计文档

## 📋 目录

1. [系统概述](#系统概述)
2. [核心架构](#核心架构)
3. [模块设计](#模块设计)
4. [数据流程](#数据流程)
5. [技术选型](#技术选型)
6. [性能优化](#性能优化)
7. [扩展性设计](#扩展性设计)

## 系统概述

RAG（Retrieval-Augmented Generation）智能问答系统是一个基于检索增强生成技术的企业级问答解决方案。系统通过结合向量检索、语义重排和大语言模型，实现了准确、高效的文档问答功能。

### 核心目标

- **准确性**：通过多阶段检索和重排，确保返回最相关的内容
- **高效性**：使用向量数据库和批处理技术，实现毫秒级响应
- **可扩展性**：模块化设计，支持灵活扩展和定制
- **易用性**：提供友好的 API 和 Web 界面

## 核心架构

### 系统分层

```
┌─────────────────────────────────────────────────────────┐
│                     表现层 (Presentation)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  Web UI      │  │  RESTful API │  │  WebSocket   │  │
│  │ (HTML/JS)    │  │  (FastAPI)   │  │  (实时通信)   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                     业务层 (Business)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  查询服务     │  │  摄取服务     │  │  管理服务     │  │
│  │  (Query)     │  │  (Ingest)    │  │  (Admin)     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                     核心层 (Core)                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │ 嵌入引擎  │ │ 向量存储  │ │ 重排引擎  │ │LLM客户端 │  │
│  │Embedding │ │ Vector   │ │ Rerank   │ │   LLM    │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │文档处理器 │ │ 日志管理  │ │ 异常处理  │ │ 配置管理 │  │
│  │Processor │ │ Logger   │ │Exception │ │ Config   │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                   数据持久层 (Data)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  ChromaDB    │  │  文件系统     │  │  缓存系统     │  │
│  │ (向量数据库)  │  │  (文档存储)   │  │  (Redis)     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 模块设计

### 1. 配置管理模块 (config.py)

**职责**：集中管理所有系统配置

**功能**：
- 环境变量加载
- 路径配置
- API 配置
- 参数配置
- 配置验证

**设计模式**：单例模式

```python
class Config:
    BASE_DIR = Path(__file__).resolve().parent
    # ... 其他配置

    @classmethod
    def validate(cls) -> bool:
        """验证配置有效性"""
        pass
```

### 2. 嵌入引擎 (core/embeddings.py)

**职责**：文本向量化

**技术栈**：
- Sentence Transformers
- 本地嵌入模型（ACGE）

**核心方法**：
```python
class EmbeddingEngine:
    def encode(self, sentences: List[str]) -> List[List[float]]:
        """将文本转换为向量"""
        pass
```

**性能优化**：
- 批处理
- GPU 加速（可选）
- 结果缓存

### 3. 向量存储管理器 (core/vector_store.py)

**职责**：管理向量数据库

**技术栈**：
- ChromaDB
- 余弦相似度度量

**核心方法**：
```python
class VectorStoreManager:
    def add_documents(self, ids, embeddings, documents, metadatas):
        """添加文档到向量数据库"""
        pass

    def query(self, query_embeddings, n_results) -> Dict:
        """查询相似文档"""
        pass
```

### 4. 重排引擎 (core/reranker.py)

**职责**：对检索结果进行精确排序

**技术栈**：
- SiliconFlow Rerank API
- BGE Reranker v2-m3

**工作原理**：
1. 接收查询和候选文档
2. 调用 Rerank API
3. 返回按相关性排序的结果

### 5. LLM 客户端 (core/llm_client.py)

**职责**：与大语言模型交互

**技术栈**：
- SiliconFlow API
- DeepSeek-R1-Distill-Qwen-7B

**核心方法**：
```python
class LLMClient:
    def generate(self, context: str, user_query: str) -> str:
        """生成回答"""
        pass
```

### 6. 文档处理器 (core/processor.py)

**职责**：处理和分割文档

**功能**：
- Markdown 解析
- 章节分割
- 段落提取
- 哈希生成

**分块策略**：
- 父子节点结构
- 基于标题的层次分割
- 保持语义完整性

## 数据流程

### 数据摄取流程

```
Markdown 文档
    │
    ▼
┌─────────────────┐
│ 1. 文档读取      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. 文档分块      │  ─► 父节点映射 (JSON)
│  - 按标题分割    │
│  - 段落提取      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. 文本向量化    │
│  - 批量编码      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 4. 向量存储      │
│  - ChromaDB     │
└─────────────────┘
```

### 查询流程

```
用户问题
    │
    ▼
┌─────────────────┐
│ 1. 问题向量化    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. 向量检索      │
│  召回 N 个候选   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. 相似度过滤    │
│  阈值过滤        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 4. 重排（可选）  │
│  精确排序        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 5. 上下文组装    │
│  获取完整章节    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 6. LLM 生成      │
│  生成最终答案    │
└────────┬────────┘
         │
         ▼
      用户答案
```

## 技术选型

### Web 框架

**FastAPI**

选择原因：
- 高性能（基于 Starlette 和 Pydantic）
- 自动生成 API 文档
- 类型检查和验证
- 异步支持

### 向量数据库

**ChromaDB**

选择原因：
- 轻量级，易于部署
- Python 原生支持
- 持久化存储
- 余弦相似度搜索

### 嵌入模型

**ACGE Text Embedding**

选择原因：
- 中文效果优秀
- 本地部署，无需网络
- 维度适中（768）
- 速度快

### LLM API

**SiliconFlow**

选择原因：
- 国内访问稳定
- 支持多种模型
- 价格合理
- 完善的 API

## 性能优化

### 1. 向量检索优化

- **索引优化**：使用 HNSW 算法
- **批量查询**：支持批量检索
- **结果缓存**：缓存常见查询

### 2. 嵌入生成优化

- **批处理**：批量编码文本
- **GPU 加速**：支持 CUDA
- **模型量化**：减少内存占用

### 3. API 性能优化

- **异步处理**：使用 async/await
- **连接池**：复用 HTTP 连接
- **限流控制**：防止过载

### 4. 内存优化

- **流式处理**：大文件分块处理
- **按需加载**：延迟加载模型
- **垃圾回收**：定期清理缓存

## 扩展性设计

### 水平扩展

- 支持多实例部署
- 负载均衡
- 分布式向量数据库

### 功能扩展

- 插件系统
- 自定义嵌入模型
- 多种 LLM 支持
- 自定义重排策略

### 数据源扩展

- PDF 支持
- Word 文档支持
- 网页爬取
- 数据库集成

### 接口扩展

- GraphQL API
- WebSocket 实时通信
- gRPC 支持
- SDK 开发

## 安全性设计

### 1. API 安全

- API 密钥认证
- 请求签名
- 速率限制
- IP 白名单

### 2. 数据安全

- 敏感信息过滤
- 数据加密存储
- 访问控制
- 审计日志

### 3. 模型安全

- 输入验证
- 输出过滤
- Prompt 注入防护
- 内容审核

## 监控与运维

### 日志系统

- 结构化日志
- 日志等级分类
- 日志文件轮转
- 集中式日志管理

### 监控指标

- API 响应时间
- 向量检索性能
- LLM 调用延迟
- 系统资源使用

### 告警机制

- 错误率告警
- 性能告警
- 资源告警
- 自动恢复

## 未来规划

### 短期目标（1-3个月）

- [ ] 添加更多文档格式支持
- [ ] 实现对话历史记忆
- [ ] 优化检索算法
- [ ] 添加单元测试

### 中期目标（3-6个月）

- [ ] 多租户支持
- [ ] 分布式部署
- [ ] 实时数据更新
- [ ] 高级分析功能

### 长期目标（6-12个月）

- [ ] 多模态支持（图片、音频）
- [ ] 知识图谱集成
- [ ] 自动化运维
- [ ] 企业级 SaaS 平台

---

**文档版本**: v1.0.0
**最后更新**: 2026-01-14
**维护者**: RAG 项目团队
