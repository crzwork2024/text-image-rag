<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜åå° - RAG æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #f8fafc;
            color: #1e293b;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            color: #1e293b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
        }

        tr:hover {
            background: #f8fafc;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-auto {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-confirmed {
            background: #dcfce7;
            color: #15803d;
        }

        .badge-manual {
            background: #fef3c7;
            color: #92400e;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.3rem;
            color: #1e293b;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #475569;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 150px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .answer-preview {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ› ï¸ ç®¡ç†å‘˜åå°</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openAddModal()" style="background: #10b981; color: white;">
                    â• æ‰‹åŠ¨æ·»åŠ ç¼“å­˜
                </button>
                <a href="/" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
                <button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-cache">-</div>
                <div class="stat-label">æ€»ç¼“å­˜æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-hits">-</div>
                <div class="stat-label">æ€»å‘½ä¸­æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="manual-cache">-</div>
                <div class="stat-label">æ‰‹åŠ¨ç¼“å­˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="confirmed-cache">-</div>
                <div class="stat-label">ç”¨æˆ·ç¡®è®¤</div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('hot-questions')">ğŸ”¥ çƒ­é—¨é—®é¢˜</button>
            <button class="tab" onclick="switchTab('cache-list')">ğŸ“¦ ç¼“å­˜åˆ—è¡¨</button>
            <button class="tab" onclick="switchTab('cache-management')">ğŸ—‘ï¸ ç¼“å­˜ç®¡ç†</button>
        </div>

        <!-- çƒ­é—¨é—®é¢˜æ ‡ç­¾é¡µ -->
        <div class="tab-content active" id="hot-questions">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin-bottom: 0;">çƒ­é—¨é—®é¢˜ç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="openAddModal()" style="background: #10b981;">
                        â• æ‰‹åŠ¨æ·»åŠ ç¼“å­˜
                    </button>
                </div>
                <div id="hot-questions-content" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ç¼“å­˜åˆ—è¡¨æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="cache-list">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin-bottom: 0;">ç¼“å­˜é—®é¢˜åˆ—è¡¨</h2>
                    <button class="btn btn-primary" onclick="openAddModal()" style="background: #10b981;">
                        â• æ‰‹åŠ¨æ·»åŠ ç¼“å­˜
                    </button>
                </div>
                <div id="cache-list-content" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ç¼“å­˜ç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="cache-management">
            <div class="card">
                <h2>ç¼“å­˜ç®¡ç†æ“ä½œ</h2>
                <p style="margin-bottom: 2rem; color: #64748b;">
                    âš ï¸ å±é™©æ“ä½œï¼šæ¸…é™¤ç¼“å­˜å°†æ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼
                </p>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-warning" onclick="clearCacheByType(['auto'])">
                        æ¸…é™¤è‡ªåŠ¨ç¼“å­˜
                    </button>
                    <button class="btn btn-danger" onclick="clearAllCache()">
                        æ¸…é™¤æ‰€æœ‰ç¼“å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹é—®ç­”æ¨¡æ€æ¡† -->
    <div class="modal" id="view-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æŸ¥çœ‹é—®ç­”</h3>
                <button class="btn-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- æ‰‹åŠ¨æ·»åŠ ç¼“å­˜æ¨¡æ€æ¡† -->
    <div class="modal" id="add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ‰‹åŠ¨æ·»åŠ åˆ°ç¼“å­˜</h3>
                <button class="btn-close" onclick="closeAddModal()">&times;</button>
            </div>
            <form onsubmit="submitManualCache(event)">
                <div class="form-group">
                    <label for="cache-question">é—®é¢˜</label>
                    <textarea id="cache-question" required></textarea>
                </div>
                <div class="form-group">
                    <label for="cache-answer">ç­”æ¡ˆ</label>
                    <textarea id="cache-answer" required></textarea>
                </div>
                <div class="form-group">
                    <label for="quality-score">è´¨é‡åˆ†æ•° (1-10)</label>
                    <input type="number" id="quality-score" min="1" max="10" value="10">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    æ·»åŠ åˆ°ç¼“å­˜
                </button>
            </form>
        </div>
    </div>

    <script>
        let currentToken = '';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            const expires = localStorage.getItem('admin_expires');
            
            if (!token || !expires) {
                window.location.href = '/admin-login.html';
                return null;
            }
            
            const expiresDate = new Date(expires);
            if (expiresDate <= new Date()) {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_expires');
                window.location.href = '/admin-login.html';
                return null;
            }
            
            currentToken = token;
            return token;
        }

        // ç™»å‡º
        async function logout() {
            try {
                await fetch('/admin/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
            } catch (error) {
                console.error('ç™»å‡ºé”™è¯¯:', error);
            }
            
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_expires');
            window.location.href = '/admin-login.html';
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'success' ? '#10b981' : '#ef4444';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'hot-questions') {
                loadHotQuestions();
            } else if (tabName === 'cache-list') {
                loadCacheList();
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch('/cache/stats', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                const data = await response.json();
                
                document.getElementById('total-cache').textContent = data.total_entries || 0;
                document.getElementById('total-hits').textContent = data.total_hits || 0;
                document.getElementById('manual-cache').textContent = data.cache_by_type?.manual || 0;
                document.getElementById('confirmed-cache').textContent = data.cache_by_type?.confirmed || 0;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // å¤„ç†è®¤è¯å¤±è´¥
        function handleAuthError(response) {
            if (response.status === 401) {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_expires');
                showToast('âŒ ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                setTimeout(() => {
                    window.location.href = '/admin-login.html';
                }, 1500);
                return true;
            }
            return false;
        }

        // åŠ è½½çƒ­é—¨é—®é¢˜
        async function loadHotQuestions() {
            const container = document.getElementById('hot-questions-content');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch('/admin/hot-questions?limit=50', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (handleAuthError(response)) return;
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const data = await response.json();
                
                if (!data.hot_questions || data.hot_questions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <p>æš‚æ— çƒ­é—¨é—®é¢˜</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>é—®é¢˜</th>
                                <th>æé—®æ¬¡æ•°</th>
                                <th>ç¼“å­˜çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.hot_questions.forEach(item => {
                    const cacheTypeText = item.cache_type ? 
                        `<span class="badge badge-${item.cache_type}">${item.cache_type}</span>` : 
                        'æœªç¼“å­˜';
                    
                    html += `
                        <tr>
                            <td>${item.question}</td>
                            <td>${item.count}</td>
                            <td>${cacheTypeText}</td>
                            <td>
                                ${!item.cached ? 
                                    `<button class="btn btn-primary btn-sm" onclick="viewAndCache('${item.question.replace(/'/g, "\\'")}')">
                                        æŸ¥çœ‹å¹¶ç¼“å­˜
                                    </button>` : 
                                    `<button class="btn btn-sm" onclick="viewCachedAnswer('${item.cache_id}')">
                                        æŸ¥çœ‹ç­”æ¡ˆ
                                    </button>`
                                }
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½çƒ­é—¨é—®é¢˜å¤±è´¥:', error);
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        // åŠ è½½ç¼“å­˜åˆ—è¡¨
        async function loadCacheList() {
            const container = document.getElementById('cache-list-content');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch('/admin/cache/list?limit=1000', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (handleAuthError(response)) return;
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const data = await response.json();
                
                if (!data.cached_questions || data.cached_questions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <p>æš‚æ— ç¼“å­˜æ•°æ®</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>é—®é¢˜</th>
                                <th>ç±»å‹</th>
                                <th>è´¨é‡åˆ†</th>
                                <th>å‘½ä¸­æ¬¡æ•°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.cached_questions.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.question}</td>
                            <td><span class="badge badge-${item.cache_type}">${item.cache_type}</span></td>
                            <td>${item.quality_score}</td>
                            <td>${item.hit_count}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewCachedAnswer('${item.cache_id}')" style="margin-right: 8px;">
                                    æŸ¥çœ‹/ç¼–è¾‘
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteCacheItem('${item.cache_id}')">
                                    åˆ é™¤
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½ç¼“å­˜åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        // æŸ¥çœ‹å·²ç¼“å­˜çš„ç­”æ¡ˆ
        async function viewCachedAnswer(cacheId) {
            const modal = document.getElementById('add-modal');
            const modalTitle = modal.querySelector('.modal-header h3');
            modalTitle.textContent = 'æŸ¥çœ‹å’Œç¼–è¾‘ç¼“å­˜';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('cache-question').value = 'åŠ è½½ä¸­...';
            document.getElementById('cache-answer').value = 'åŠ è½½ä¸­...';
            modal.classList.add('show');
            
            try {
                // ä»ç¼“å­˜åˆ—è¡¨APIè·å–è¯¦æƒ…
                const response = await fetch('/admin/cache/list?limit=1000', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (handleAuthError(response)) {
                    closeAddModal();
                    return;
                }
                
                const data = await response.json();
                const cacheItem = data.cached_questions.find(item => item.cache_id === cacheId);
                
                if (cacheItem) {
                    document.getElementById('cache-question').value = cacheItem.question;
                    document.getElementById('cache-answer').value = cacheItem.answer;
                    document.getElementById('quality-score').value = cacheItem.quality_score || 10;
                    
                    // å­˜å‚¨å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç¼“å­˜ID
                    modal.dataset.editingCacheId = cacheId;
                    modal.dataset.isEditing = 'true';
                } else {
                    showToast('âŒ æœªæ‰¾åˆ°ç¼“å­˜æ•°æ®', 'error');
                    closeAddModal();
                }
                
            } catch (error) {
                console.error('åŠ è½½ç¼“å­˜è¯¦æƒ…å¤±è´¥:', error);
                showToast('âŒ åŠ è½½å¤±è´¥', 'error');
                closeAddModal();
            }
        }

        // æŸ¥çœ‹å¹¶ç¼“å­˜
        async function viewAndCache(question) {
            const modal = document.getElementById('add-modal');
            const modalTitle = modal.querySelector('.modal-header h3');
            modalTitle.textContent = 'æŸ¥çœ‹å¹¶æ·»åŠ åˆ°ç¼“å­˜';
            
            // æ¸…ç©ºç¼–è¾‘çŠ¶æ€
            delete modal.dataset.editingCacheId;
            delete modal.dataset.isEditing;
            
            // è®¾ç½®é—®é¢˜
            document.getElementById('cache-question').value = question;
            document.getElementById('cache-answer').value = 'æ­£åœ¨ç”Ÿæˆç­”æ¡ˆ...';
            document.getElementById('quality-score').value = 10;
            
            modal.classList.add('show');
            
            try {
                // æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢è·å–ç­”æ¡ˆ
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: question,
                        use_rerank: true,
                        use_query_enhancement: false
                    })
                });
                
                const data = await response.json();
                
                // å¡«å……ç­”æ¡ˆåˆ°æ–‡æœ¬æ¡†ï¼Œè®©ç”¨æˆ·å¯ä»¥ç¼–è¾‘
                document.getElementById('cache-answer').value = data.answer;
                
            } catch (error) {
                console.error('æŸ¥è¯¢å¤±è´¥:', error);
                document.getElementById('cache-answer').value = 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ç­”æ¡ˆæˆ–é‡è¯•';
                showToast('âŒ è‡ªåŠ¨æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ç­”æ¡ˆ', 'error');
            }
        }

        // æäº¤æ‰‹åŠ¨ç¼“å­˜è¡¨å•
        async function submitManualCache(event) {
            event.preventDefault();
            
            const modal = document.getElementById('add-modal');
            const question = document.getElementById('cache-question').value;
            const answer = document.getElementById('cache-answer').value;
            const qualityScore = parseInt(document.getElementById('quality-score').value);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘æ¨¡å¼
            const isEditing = modal.dataset.isEditing === 'true';
            const editingCacheId = modal.dataset.editingCacheId;
            
            try {
                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå…ˆåˆ é™¤æ—§ç¼“å­˜
                if (isEditing && editingCacheId) {
                    const deleteResponse = await fetch(`/admin/cache/${editingCacheId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        }
                    });
                    
                    if (handleAuthError(deleteResponse)) return;
                    
                    if (!deleteResponse.ok) {
                        showToast('âŒ åˆ é™¤æ—§ç¼“å­˜å¤±è´¥', 'error');
                        return;
                    }
                }
                
                // æ·»åŠ æ–°ç¼“å­˜
                const response = await fetch('/admin/cache/add', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        answer: answer,
                        quality_score: qualityScore
                    })
                });
                
                if (handleAuthError(response)) return;
                
                if (response.ok) {
                    showToast(isEditing ? 'âœ… ç¼“å­˜å·²æ›´æ–°' : 'âœ… å·²æ·»åŠ åˆ°ç¼“å­˜');
                    closeAddModal();
                    loadHotQuestions();
                    loadCacheList();
                    loadStats();
                } else {
                    const errorData = await response.json();
                    showToast(`âŒ ${errorData.detail || 'æ“ä½œå¤±è´¥'}`, 'error');
                }
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                showToast('âŒ æ“ä½œå¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ç¼“å­˜é¡¹
        async function deleteCacheItem(cacheId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç¼“å­˜å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/admin/cache/${cacheId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (handleAuthError(response)) return;
                
                if (response.ok) {
                    showToast('âœ… å·²åˆ é™¤ç¼“å­˜');
                    loadCacheList();
                    loadStats();
                } else {
                    showToast('âŒ åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showToast('âŒ åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ¸…é™¤æŒ‡å®šç±»å‹çš„ç¼“å­˜
        async function clearCacheByType(types) {
            const typeText = types.join(', ');
            if (!confirm(`ç¡®å®šè¦æ¸…é™¤ ${typeText} ç±»å‹çš„æ‰€æœ‰ç¼“å­˜å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼`)) return;
            
            try {
                const response = await fetch('/admin/cache/clear', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cache_types: types,
                        confirm: true
                    })
                });
                
                if (handleAuthError(response)) return;
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`âœ… å·²æ¸…é™¤ ${data.deleted_count} æ¡ç¼“å­˜`);
                    loadStats();
                    loadCacheList();
                } else {
                    showToast('âŒ æ¸…é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¸…é™¤å¤±è´¥:', error);
                showToast('âŒ æ¸…é™¤å¤±è´¥', 'error');
            }
        }

        // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
        async function clearAllCache() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼')) return;
            if (!confirm('è¯·å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/admin/cache/clear', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cache_types: null,
                        confirm: true
                    })
                });
                
                if (handleAuthError(response)) return;
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`âœ… å·²æ¸…é™¤æ‰€æœ‰ç¼“å­˜ (${data.deleted_count} æ¡)`);
                    loadStats();
                    loadCacheList();
                } else {
                    showToast('âŒ æ¸…é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¸…é™¤å¤±è´¥:', error);
                showToast('âŒ æ¸…é™¤å¤±è´¥', 'error');
            }
        }

        // æ‰“å¼€æ‰‹åŠ¨æ·»åŠ æ¨¡æ€æ¡†
        function openAddModal() {
            const modal = document.getElementById('add-modal');
            const modalTitle = modal.querySelector('.modal-header h3');
            modalTitle.textContent = 'æ‰‹åŠ¨æ·»åŠ åˆ°ç¼“å­˜';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('cache-question').value = '';
            document.getElementById('cache-answer').value = '';
            document.getElementById('quality-score').value = 10;
            
            // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
            delete modal.dataset.editingCacheId;
            delete modal.dataset.isEditing;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.classList.add('show');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('view-modal').classList.remove('show');
        }

        function closeAddModal() {
            const modal = document.getElementById('add-modal');
            modal.classList.remove('show');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('cache-question').value = '';
            document.getElementById('cache-answer').value = '';
            document.getElementById('quality-score').value = 10;
            
            // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
            delete modal.dataset.editingCacheId;
            delete modal.dataset.isEditing;
            
            // æ¢å¤æ ‡é¢˜
            modal.querySelector('.modal-header h3').textContent = 'æ‰‹åŠ¨æ·»åŠ åˆ°ç¼“å­˜';
        }

        // é¡µé¢åŠ è½½
        window.onload = function() {
            if (checkAuth()) {
                loadStats();
                loadHotQuestions();
            }
        };
    </script>
</body>
</html>
