# 缓存管理功能说明

## 📋 功能概述

本系统实现了基于用户反馈和管理员精选的智能缓存策略，确保只缓存高质量答案。

## 🎯 核心特性

### 1. 用户满意度反馈
- **位置**：每次回答下方显示"满意"/"不满意"按钮
- **功能**：用户点击"满意"后，问答对自动添加到高质量缓存
- **缓存类型**：`confirmed`（已确认）
- **质量分数**：5/10

### 2. 管理员后台管理
- **访问地址**：`http://localhost:8000/admin-login.html`
- **默认账号**：
  - 用户名：`admin`
  - 密码：`admin123`
- **功能**：
  - 查看热门问题统计
  - 手动添加精选问答
  - 管理已有缓存
  - 清除缓存数据

### 3. 三级缓存系统

| 缓存类型 | 来源 | 质量分数 | 优先级 |
|---------|------|---------|--------|
| `manual` | 管理员手动添加 | 10 | 最高 |
| `confirmed` | 用户满意反馈 | 5 | 中等 |
| `auto` | 自动缓存（已禁用） | 0 | 最低 |

## 🚀 使用指南

### 普通用户

1. **提问并查看答案**
   - 在主页输入问题
   - 查看系统生成的答案

2. **满意度反馈**
   - 如果答案满意，点击"👍 满意"按钮
   - 该问答对将被添加到高质量缓存
   - 下次相同或类似问题会直接返回此答案

3. **查看热门问题**
   - 页面顶部显示热门问题列表
   - 点击可快速提问

### 管理员

#### 登录后台

1. 点击首页右下角的"🔐 管理员"按钮
2. 输入用户名和密码登录
3. 进入管理员后台界面

#### 热门问题管理

1. **查看热门问题**
   - 显示所有被提问过的问题
   - 显示提问次数和缓存状态
   
2. **查看并缓存**
   - 点击"查看并缓存"按钮
   - 预览问题和答案
   - 确认后添加到高优先级缓存

#### 缓存列表管理

1. **查看所有缓存**
   - 显示所有已缓存的问答对
   - 显示缓存类型、质量分数、命中次数
   
2. **删除缓存**
   - 点击"删除"按钮移除指定缓存
   - 适用于错误或过时的答案

#### 缓存清理

1. **清除自动缓存**
   - 保留用户确认和手动添加的缓存
   - 清除低质量的自动缓存

2. **清除所有缓存**
   - ⚠️ 危险操作
   - 需要二次确认
   - 清空所有缓存数据

## 🔧 配置说明

### 修改管理员密码

1. 生成密码哈希：
```bash
python -c "import hashlib; print(hashlib.sha256('your_new_password'.encode()).hexdigest())"
```

2. 在 `.env` 文件中更新：
```env
ADMIN_PASSWORD_HASH=生成的哈希值
```

### 缓存参数配置

在 `.env` 文件中：

```env
# 缓存相似度阈值
CACHE_THRESHOLD_DIRECT=0.98   # 直接返回缓存的相似度阈值
CACHE_THRESHOLD_CONFIRM=0.95  # 提示用户确认的相似度阈值

# 缓存设置
CACHE_TTL=3600                # 缓存过期时间（秒）
CACHE_MAX_SIZE=1000           # 最大缓存条目数
```

## 📊 API 接口

### 用户反馈接口
```
POST /cache/feedback
Content-Type: application/json

{
  "session_id": "session_xxx",
  "question": "用户问题",
  "answer": "系统答案",
  "satisfied": true
}
```

### 管理员接口

所有管理员接口需要在 Header 中携带认证令牌：
```
Authorization: Bearer {token}
```

#### 登录
```
POST /admin/login
{
  "username": "admin",
  "password": "admin123"
}
```

#### 获取热门问题
```
GET /admin/hot-questions?limit=50&min_count=1
```

#### 手动添加缓存
```
POST /admin/cache/add
{
  "question": "问题文本",
  "answer": "答案文本",
  "quality_score": 10
}
```

#### 清除缓存
```
DELETE /admin/cache/clear
{
  "cache_types": ["auto"],  // null 表示全部
  "confirm": true
}
```

## 🔒 安全建议

1. **修改默认密码**
   - 部署到生产环境前必须修改默认密码

2. **使用 HTTPS**
   - 生产环境建议配置 HTTPS 保护管理员登录

3. **定期备份**
   - Redis 数据定期备份
   - 重要缓存可导出备份

4. **访问控制**
   - 限制管理员后台访问 IP
   - 配置防火墙规则

## 🐛 故障排查

### 缓存不工作
1. 检查 Redis 是否运行：`redis-cli ping`
2. 检查 `.env` 中的 Redis 配置
3. 查看日志：`logs/API_YYYYMMDD.log`

### 管理员登录失败
1. 确认密码哈希值正确
2. 检查 token 是否过期（默认 1 小时）
3. 清除浏览器 localStorage

### 满意度按钮不显示
1. 检查答案是否来自缓存（缓存答案不显示反馈按钮）
2. 检查是否已提交过反馈（每次提问只能反馈一次）

## 📝 更新日志

### v2.0.0 (2026-01-14)
- ✅ 添加用户满意度反馈功能
- ✅ 实现管理员后台系统
- ✅ 支持三级缓存策略
- ✅ 热门问题统计和管理
- ✅ 缓存类型和质量分数系统
- ✅ 禁用自动缓存，改为用户确认/管理员精选模式

## 📞 技术支持

如有问题，请查看：
- 日志文件：`logs/API_YYYYMMDD.log`
- Redis 状态：`redis-cli info`
- 系统健康：`http://localhost:8000/health`
- 缓存统计：`http://localhost:8000/cache/stats`
